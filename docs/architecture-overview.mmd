%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#fff','primaryTextColor':'#000','primaryBorderColor':'#000','lineColor':'#000','secondaryColor':'#fff','tertiaryColor':'#fff','background':'#ffffff','mainBkg':'#ffffff','secondBkg':'#ffffff','lineColor':'#000000','border1':'#000000','border2':'#000000','arrowheadColor':'#000000','fontFamily':'arial','fontSize':'14px'}}}%%
flowchart TB
    %% Styling for different component types - thick borders for maximum visibility
    classDef uiStyle fill:#ADD8E6,stroke:#000080,stroke-width:5px,color:#000,font-weight:bold
    classDef apiStyle fill:#90EE90,stroke:#006400,stroke-width:5px,color:#000,font-weight:bold
    classDef orchestratorStyle fill:#F5DEB3,stroke:#8B4513,stroke-width:5px,color:#000,font-weight:bold
    classDef agentStyle fill:#FFFFE0,stroke:#FF8C00,stroke-width:5px,color:#000,font-weight:bold
    classDef storageStyle fill:#E0FFFF,stroke:#008B8B,stroke-width:5px,color:#000,font-weight:bold
    classDef llmStyle fill:#FFB6C1,stroke:#DC143C,stroke-width:5px,color:#000,font-weight:bold

    %% Link styles - very thick black lines for visibility in all modes
    linkStyle default stroke:#000000,stroke-width:4px,color:#000000

    %% Frontend Layer
    UI[React + Tailwind<br/>Frontend]:::uiStyle

    %% API Layer
    API[Spring Boot 4<br/>WebFlux API]:::apiStyle

    %% Orchestration Layer
    ORCH[Multi-Agent<br/>Orchestrator]:::orchestratorStyle

    %% Storage Layer
    VS[(Vector Store<br/>Service)]:::storageStyle
    DB[(pgvector<br/>PostgreSQL)]:::storageStyle

    %% LLM Layer
    OLLAMA[Ollama LLM<br/>llama3.2:1b<br/>nomic-embed-text]:::llmStyle

    %% Agent Subgraph
    subgraph Agents["ü§ñ Specialized Agents"]
        direction TB
        R[Router<br/>Agent]:::agentStyle
        P[Planner<br/>Agent]:::agentStyle
        RET[Parallel<br/>Retrievers<br/>k=6,10,14]:::agentStyle
        S[Synthesizer<br/>Agent]:::agentStyle
        J[Judge<br/>Agent]:::agentStyle
        Q[Query Rewrite<br/>Agent]:::agentStyle
    end

    %% User Interactions
    UI -->|"SSE /api/chat/stream<br/>?question=..."| API
    UI -->|"multipart /api/ingest/file"| API
    API -->|"SSE events: agent + final"| UI
    API -->|"SSE /api/ingest/progress<br/>?jobId=..."| UI

    %% API to Orchestrator
    API --> ORCH

    %% Orchestrator to Agents Flow
    ORCH --> R
    R --> P
    P --> RET
    RET --> S
    S --> J

    %% Judge Decision Paths
    J -->|"‚úÖ pass"| OUT[Final Answer<br/>+ Citations]:::uiStyle
    J -->|"‚ùå fail<br/>(retry)"| Q
    Q -->|"rewrite query"| RET

    %% Agent to Storage/LLM
    RET -->|"vector search<br/>cosine similarity"| VS
    VS -->|"SQL queries"| DB

    S -->|"chat API<br/>(grounding prompt)"| OLLAMA
    Q -->|"chat API<br/>(rewrite prompt)"| OLLAMA

    %% Ingestion Flow
    API -->|"ingest docs<br/>+ embed"| VS
    VS -->|"embed text"| OLLAMA

    %% Storage
    VS -->|"store chunks<br/>+ embeddings"| DB
